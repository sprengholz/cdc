<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey</title>

    <link rel="stylesheet" href="https://unpkg.com/survey-core@2.3.14/survey-core.min.css" />
    <link rel="stylesheet" href="./index.css" />
    <link rel="stylesheet" href="./app.min.css" />

    <script src="https://unpkg.com/survey-core@2.3.14/survey.core.min.js"></script>
    <script src="https://unpkg.com/survey-core@2.3.14/survey.i18n.min.js"></script>
    <script src="https://unpkg.com/survey-core@2.3.14/themes/index.min.js"></script>
    <script src="https://unpkg.com/survey-js-ui@2.3.14/survey-js-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
</head>

<body style="background-color: #eee;">

    <div id="websiteContainer" style="display: none;">...</div>


    <div id="surveyContainer"></div>


    <script>

        // Helper: get a query parameter from URL
        function getParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        let condition = Math.random() < 0.5 ? "new" : "old";

        function showWebsite() {
            document.getElementById("websiteContainer").style.display = "block";
        }

        function hideWebsite() {
            document.getElementById("websiteContainer").style.display = "none";
        }

        fetch(condition + ".html")
            .then(response => response.text())
            .then(html => {
                document.getElementById("websiteContainer").innerHTML = html;
            })
            .catch(err => console.error("Error loading HTML:", err));

        function initSurvey() {

            const userId = getParam("id");
            if (!userId) {
                document.body.innerHTML = "<h3>‚ùå Fehlender URL-Parameter!</h3>";
                return;
            }



            var surveyJson = {
                showPrevButton: false,
                questionTitlePattern: "numTitle",
                completedHtml: "<img src='img/animation.gif' style='width: 100px;'/><p>Thank you! Your answers are stored, please wait...</p>",
                pages: [
                    {
                        name: "consent",

                        elements: [
                            {
                                "type": "html",
                                "name": "briefing",
                                "html": "<h3>Hello!</h3><p>Thank you very much for taking part in this short survey from the University of Bamberg, Germany. You will be shown a website and asked some questions about childhood vaccination. The entire survey will take about 5 minutes to complete. Your participation is voluntary, and you may withdraw at any time.</p><p>Your responses will be collected for scientific purposes and may be stored permanently in an anonymized form in a public repository. It will not be possible to trace the data back to you. For more information on data processing, please see <a href='https://www.uni-bamberg.de/datenschutz/datenschutzinformationen/allgemeine-inhalte-datenschutzinformationen/', target='_blank'>here</a>. You can withdraw your consent to data processing at any time by emailing <a href='mailto:philipp.sprengholz@uni-bamberg.de'>philipp.sprengholz@uni-bamberg.de</a></p>",
                                "startWithNewLine": false
                            },
                            {

                                "type": "boolean",
                                "name": "consent",
                                "title": "**Consent**",
                                "labelTrue": "Yes, I would like to participate in the survey and consent to the processing of my data for the purpose of scientific research.",
                                "labelFalse": "No, I do not want to participate in the survey.",
                                "renderAs": "radio",
                                "isRequired": true,
                                "swapOrder": true
                            }
                        ]
                    },
                    {
                        name: "screener",
                        elements: [
                            {
                                type: "radiogroup",
                                name: "children",
                                title: "**How many children do you have?**",
                                isRequired: true,
                                colCount: 1,
                                choices: ["0", "1", "2", "3 or more"]
                            },
                            {
                                type: "radiogroup",
                                name: "childage",
                                title: "**How old is your youngest child?**",
                                isRequired: true,
                                colCount: 1,
                                choices: ["Less than 1 year old", "1 year old or older"],
                                visibleIf: "{children} == '1' or {children} == '2' or {children} == '3 or more'"
                            }
                        ]
                    },
                    {
                        name: "briefing",
                        elements: [
                            {
                                type: "html",
                                html: "<p><b>On the next page, you will see a website published by the Center for Disease Control and Prevention (CDC).</b></p><p><b>Please take at least 2 minutes to review the information presented on the website before proceeding. After 2 minutes, the <i>Next</i> button will appear at the end of the website.</b></p>"
                            }

                        ]
                    },
                    {
                        name: "website",
                        elements: [
                            {
                                type: "html",
                                name: "countdown",
                                html: "<p id='countdowninfo'>Please spend at least 2 minutes on this page. <span id='countdownremaining'>The <i>Next</i> button will appear in <b>120 seconds</b></span>.</p>"
                            }
                        ]
                    },
                    {
                        name: "vaccination",
                        elements: [
                            {
                                type: "rating",
                                name: "sideeffects",
                                title: "**How likely do you think it is that children will experience serious side effects from vaccination?**",
                                minRateDescription: "extremely unlikely",
                                maxRateDescription: "extremely likeley",
                                rateMin: 1,
                                rateMax: 7,
                                isRequired: true
                            },
                            {
                                type: "rating",
                                name: "vaccintention",
                                title: "**In the US, children receive vaccination against measles, mumps and rubella (MMR) in two doses. The first dose is given at 12-15 months of age, and the second dose is given at 4-6 years of age.\n\nHow likely are you to give the MMR vaccine to your youngest child once it is 12-15 months of age?**",
                                minRateDescription: "extremely unlikely",
                                maxRateDescription: "extremely likeley",
                                rateMin: 1,
                                rateMax: 7,
                                isRequired: true
                            }
                        ]
                    },
                    {
                        name: "trust",
                        elements: [
                           {
                                type: "rating",
                                name: "trustvac",
                                title: "**How much do you trust vaccination information and recommendations from the CDC?**",
                                minRateDescription: "very little",
                                maxRateDescription: "very much",
                                rateMin: 1,
                                rateMax: 7,
                                isRequired: true
                            },
                            {
                                type: "rating",
                                name: "trustgeneral",
                                title: "**How much do you trust health-related information and recommendations from the CDC in general?**",
                                minRateDescription: "very little",
                                maxRateDescription: "very much",
                                rateMin: 1,
                                rateMax: 7,
                                isRequired: true
                            }
                        ]
                    },
                    {
                        name: "other",
                        elements: [
                             {
                                type: "rating",
                                name: "polorientation",
                                title: "**In general, how would you describe your political views?**",
                                minRateDescription: "very liberal",
                                maxRateDescription: "very conservative",
                                rateMin: 1,
                                rateMax: 7,
                                isRequired: true
                            }
                        ]
                    }
                ]
            };


            const survey = new Survey.Model(surveyJson);

            survey.setValue("condition", condition);

            survey.applyTheme(SurveyTheme.LayeredLight);

            const converter = markdownit({
                html: true
            });

            survey.onTextMarkdown.add((_, options) => {
                let str = converter.renderInline(options.text);
                options.html = str;
            });


            survey.onCurrentPageChanged.add(function (sender, options) {

                // show website on website page, then hide it again
                if (options.newCurrentPage.name === "website") {
                    showWebsite();
                } else {
                    hideWebsite();
                }



                // show countdown timer

                let countdownTimer = null;
                let countdownRemaining = 120; // seconds
                let originalNextText = "Next";

                if (options.newCurrentPage.name === "website") {

                    // Disable NEXT button completely
                    document.getElementById("sv-nav-next").style.display = "none";


                    countdownTimer = setInterval(function () {
                        countdownRemaining--;
                        document.getElementById("countdownremaining").innerHTML = "The <i>Next</i> button will appear in <b>" + countdownRemaining + " seconds</b>";
                        if (countdownRemaining <= 0) {
                            clearInterval(countdownTimer);
                            document.getElementById("sv-nav-next").style.display = "block";
                            document.getElementById("countdowninfo").innerHTML = "You can now proceed to the next page by clicking the <i>Next</i> button below.";
                        }
                    }, 1000);
                }



            });

            // screen out
            survey.onCurrentPageChanging.add(function (sender, options) {
                if (sender.currentPage.name === "screener") {
                    if (sender.getValue("children") === "0" || sender.getValue("childage") === "1 year old or older") {
                        options.cancel = true;
                        window.location.href = "https://prolific.com"; // replace with screenout URL
                    }
                }
            });

            let scrollSwitch = true;

            survey.onScrollToTop.add(function (sender, options) {

                // Only override scrolling on your specific page
                if (sender.currentPage.name === "website" && scrollSwitch == true) {
                    options.cancel = true; // cancel SurveyJS default scroll

                    // Custom scroll to top of the whole page
                    window.scrollTo({
                        top: 0,
                        behavior: "smooth"
                    });

                    scrollSwitch = false;
                }
            });

            survey.onValidateQuestion.add(function (sender, options) {
                    if (options.name === "consent" && options.value === false) {
                        options.error = "Consent is required to participate in the survey.";
                    }
                });

            survey.render(document.getElementById("surveyContainer"));
        }

        initSurvey();



    </script>
</body>

</html>