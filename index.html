<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survey</title>

    <link rel="stylesheet" href="https://unpkg.com/survey-core@2.3.14/survey-core.min.css" />
    <link rel="stylesheet" href="./index.css" />

    <script src="https://unpkg.com/survey-core@2.3.14/survey.core.min.js"></script>
    <script src="https://unpkg.com/survey-core@2.3.14/survey.i18n.min.js"></script>
    <script src="https://unpkg.com/survey-core@2.3.14/themes/index.min.js"></script>
    <script src="https://unpkg.com/survey-js-ui@2.3.14/survey-js-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
</head>

<body>

    <div id="websiteContainer" style="display: none;">...</div>


    <div id="surveyContainer"></div>


    <script>

        // Helper: get a query parameter from URL
        function getParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        let condition = Math.random() < 0.5 ? "new" : "old";

        function showWebsite() {
            document.getElementById("websiteContainer").style.display = "block";
        }

        function hideWebsite() {
            document.getElementById("websiteContainer").style.display = "none";
        }

        fetch(condition + ".html")
            .then(response => response.text())
            .then(html => {
                document.getElementById("websiteContainer").innerHTML = html;
            })
            .catch(err => console.error("Error loading HTML:", err));

        function initSurvey() {

            const userId = getParam("id");
            if (!userId) {
                document.body.innerHTML = "<h3>❌ Fehlender URL-Parameter!</h3>";
                return;
            }



            var surveyJson = {
                showPrevButton: false,
                questionTitlePattern: "numTitle",
                completedHtml: "<img src='img/animation.gif' style='width: 100px;'/><p>Vielen Dank. Ihre Antworten werden übertragen, anschließend werden Sie automatisch zu Prolific zurückgeleitet. Bitte warten...</p>",    
                pages: [
                    {
                       name: "consent",

                            elements: [
                                {
                                    "type": "html",
                                    "name": "briefing",
                                    "html": "<h3>Willkommen zurück!</h3><p>Schön, dass Sie wieder an einer Umfrage der Universität Bamberg teilnehmen. <b>Sie haben uns vor einigen Wochen einen Kassenzettel geschickt. In dieser Umfrage möchten wir näher darauf eingehen und Ihre Meinung zu einer möglichen Veränderung der Mehrwertsteuer auf Lebensmittel erfassen.</b> Die Teilnahme wird rund 5 Minuten dauern, ist freiwillig und kann jederzeit abgebrochen werden.</p><p>Ihre Angaben werden für wissenschaftliche Zwecke erhoben und können in anonymisierter Form dauerhaft in einem öffentlichen Repositorium abgelegt werden. Ein Rückschluss auf Ihre Person ist dabei keinesfalls möglich. Weitere Informationen zur Datenverarbeitung finden Sie <a href='https://www.uni-bamberg.de/datenschutz/datenschutzinformationen/allgemeine-inhalte-datenschutzinformationen/', target='_blank'>hier</a>. Sie können Ihre Zustimmung zur Datenverarbeitung jederzeit per Email an philipp.sprengholz@uni-bamberg.de widerrufen.</p>",
                                    "startWithNewLine": false
                                },
                                {

                                    "type": "boolean",
                                    "name": "consent",
                                    "title": "**Einwilligungserklärung**",
                                    "labelTrue": "**Ja, ich möchte an der Umfrage teilnehmen** und willige in die Verarbeitung meiner Daten zum Zweck der wissenschaftlichen Forschung ein.",
                                    "labelFalse": "**Nein, ich möchte nicht an der Umfrage teilnehmen.**",
                                    "renderAs": "radio",
                                    "isRequired": true,
                                    "swapOrder": true
                                }
                            ]
                    },
                    {
                        name: "website",
                        elements: [
                            {
                                type: "html",
                                html: "<h2>Survey Content</h2><p>Here is some information for you:</p>"
                            },
                            {
                                type: "rating",
                                name: "question1",
                                title: "How would you rate the content?",
                                isRequired: true,
                                rateValues: [
                                    { value: 1, text: "Very Bad" },
                                    { value: 2, text: "Bad" },
                                    { value: 3, text: "Okay" },
                                    { value: 4, text: "Good" },
                                    { value: 5, text: "Excellent" }
                                ]
                            },
                            {
                                type: "rating",
                                name: "question2",
                                title: "How likely are you to recommend this survey?",
                                isRequired: true,
                                rateValues: [
                                    { value: 1, text: "Very Unlikely" },
                                    { value: 2, text: "Unlikely" },
                                    { value: 3, text: "Neutral" },
                                    { value: 4, text: "Likely" },
                                    { value: 5, text: "Very Likely" }
                                ]
                            }
                        ]
                    },
                    {
                        name: "followup",
                        elements: [
                            {
                                type: "rating",
                                name: "question3",
                                title: "How satisfied are you with the survey experience?",
                                isRequired: true,
                                rateValues: [
                                    { value: 1, text: "Very Dissatisfied" },
                                    { value: 2, text: "Dissatisfied" },
                                    { value: 3, text: "Neutral" },
                                    { value: 4, text: "Satisfied" },
                                    { value: 5, text: "Very Satisfied" }
                                ]
                            },
                            {
                                type: "rating",
                                name: "question4",
                                title: "How clear was the survey's purpose?",
                                isRequired: true,
                                rateValues: [
                                    { value: 1, text: "Very Unclear" },
                                    { value: 2, text: "Unclear" },
                                    { value: 3, text: "Neutral" },
                                    { value: 4, text: "Clear" },
                                    { value: 5, text: "Very Clear" }
                                ]
                            }
                        ]
                    }
                ]
            };


            const survey = new Survey.Model(surveyJson);

            survey.applyTheme(SurveyTheme.LayeredLight);

            const converter = markdownit({
                html: true
            });

            survey.onTextMarkdown.add((_, options) => {
                let str = converter.renderInline(options.text);
                options.html = str;
            });

            survey.onCurrentPageChanged.add(function (sender, options) {
                if (options.newCurrentPage.name === "website") {
                    showWebsite();
                } else {
                    hideWebsite();
                }
            });

            let scrollSwitch = true;

            survey.onScrollToTop.add(function (sender, options) {

                // Only override scrolling on your specific page
                if (sender.currentPage.name === "website" && scrollSwitch == true) {
                    options.cancel = true; // cancel SurveyJS default scroll

                    // Custom scroll to top of the whole page
                    window.scrollTo({
                        top: 0,
                        behavior: "smooth"
                    });

                    scrollSwitch = false;
                }
            });

            survey.render(document.getElementById("surveyContainer"));
        }

        initSurvey();

    </script>
</body>

</html>